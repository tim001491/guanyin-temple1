<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>觀音禪寺線上靈籤</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Serif TC', serif; background-color: #f4f1ea; color: #3d2c1d; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { width: 100%; max-width: 600px; text-align: center; }
        /* 其他樣式省略以保持簡潔... */
        #hexagram-display-wrapper { padding-bottom: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid #eee9e4; }
        .hex-container { display: flex; justify-content: space-around; align-items: flex-start; gap: 1rem; }
        .hex-column { text-align: center; flex: 1; }
        .hex-title { font-size: 1rem; color: #6c584c; margin-bottom: 0.5rem; }
        .hex-name { font-size: 1.2rem; margin-top: 0.5rem; font-weight: 600; }
        .hex-lines { font-family: monospace; font-size: 1.2rem; line-height: 1.5; text-align: left; background-color: #faf8f5; padding: 10px; border-radius: 4px; border: 1px solid #eee9e4; }
        .hex-lines div.moving { color: #c0392b; font-weight: bold; }
        .hex-arrow { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 200px; }
        .hex-arrow .arrow { font-size: 2rem; color: #b08968; }
        .hex-arrow .moving-text { font-size: 1rem; color: #8a6c4c; }
        #ai-analysis-result { line-height: 1.8; font-size: 1.1rem; color: #3d2c1d; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            </header>
        <main>
            <div id="analysis-section">
                <textarea id="question-input" placeholder="請在此輸入您想問的具體問題..."></textarea>
                <button id="analysis-button">開始綜合解析</button>
                <div id="result-wrapper" style="display:none;">
                    <div id="hexagram-display-wrapper"></div>
                    <div id="ai-analysis-result"></div>
                </div>
            </div>
        </main>
        <footer>
            </footer>
    </div>

    <script>
        // ... poems 資料庫和大部分函式不變 ...
        let currentBazi = {};

        async function getAIAnalysis() {
            // ... 前置檢查不變 ...
            
            resultWrapper.style.display = 'block';
            hexagramWrapper.innerHTML = '';
            aiResultEl.innerHTML = `<p>菩薩慈悲，正在為您綜合解析，請稍候...</p>`;
            analysisButton.disabled = true;

            const payload = { 
                question: questionInput.value.trim(), 
                poemTitle: currentPoem.title, 
                poemText: currentPoem.text,
                bazi: currentBazi
            };
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) throw new Error(`伺服器錯誤: ${response.status}`);
                
                const data = await response.json();
                
                // 【核心升級】渲染包含六爻資訊的卦象顯示
                displayHexagrams(data.hexagram);

                aiResultEl.innerHTML = ''; // 清空"載入中"
                const paragraphs = data.analysis.split('\n\n').filter(p => p.trim() !== '');
                for (const p of paragraphs) {
                    aiResultEl.innerHTML += `<p>${p.replace(/\n/g, '<br>')}</p>`;
                }

            } catch (error) {
                console.error("AI解析時發生錯誤:", error);
                aiResultEl.innerHTML = `<p style="color: #c0392b;">解析服務異常，請稍後再試。(${error.message})</p>`;
            } finally {
                analysisButton.disabled = false;
            }
        }

        // 【新增】專業的卦象顯示函式
        function displayHexagrams(hex) {
            if (!hex || !hex.main || !hex.changed) {
                hexagramWrapper.innerHTML = '';
                return;
            }

            const formatLinesHTML = (lines, movingLineNum) => {
                // 從上到下顯示，所以反轉陣列
                return [...lines].reverse().map(line => {
                    const isMoving = line.line === movingLineNum;
                    return `<div class="${isMoving ? 'moving' : ''}">` + 
                           ` ${isMoving ? '»' : ' '} ${line.line}爻: ${line.branch}${line.element}` + 
                           `</div>`;
                }).join('');
            };

            hexagramWrapper.innerHTML = `
                <h3 style="font-size: 1.5rem; font-weight: 600; text-align: center; margin-bottom: 1rem; color: #b08968;">時間卦象詳解</h3>
                <div class="hex-container">
                    <div class="hex-column">
                        <div class="hex-title">本卦</div>
                        <div class="hex-lines">${formatLinesHTML(hex.main.lines, hex.movingLine)}</div>
                        <div class="hex-name">${hex.main.name}</div>
                    </div>
                    <div class="hex-arrow">
                        <div class="arrow">→</div>
                        <div class="moving-text">動爻 ${hex.movingLine}</div>
                    </div>
                    <div class="hex-column">
                        <div class="hex-title">之卦</div>
                        <div class="hex-lines">${formatLinesHTML(hex.changed.lines, -1)}</div>
                        <div class="hex-name">${hex.changed.name}</div>
                    </div>
                </div>
            `;
        }

        function initializeDateTime() {
            try {
                const today = new Date();
                const lunar = Lunar.fromDate(today);
                
                // ... 顯示日期和八字的部分不變 ...
                
                currentBazi = {
                    year: lunar.getYearInGanZhi(),
                    month: lunar.getMonth(),
                    day: lunar.getDay(),
                    hour: lunar.getTimeZhi()
                };
            } catch (error) {
                console.error("無法載入農曆日期:", error);
            }
        }
        
        // --- 頁面載入時執行的主要邏輯 ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... 初始化函式和按鈕綁定 ...
            // 此處省略未變更的程式碼以保持簡潔
            const questionInput = document.getElementById('question-input');
            const analysisButton = document.getElementById('analysis-button');
            initializeDateTime();
            analysisButton.addEventListener('click', getAIAnalysis);
        });
    </script>
</body>
</html>